

Fitting to the TRANSVIR data prototype

# Load the data

```{r}

#install.packages("devtools")
#library(devtools)
devtools::load_all()

library(lubridate)
library(patchwork)
library(tidybayes)
library(ggdist)

```

## Get data in the right format for rjmcmc model

To help with this section please consult information in the documentation on how to layour this data.frame:

* For serological data in observational model see [data_titre](../man/data_titre.Rd).
* For known exposure times [data_known_exposures](./man/data_known_exposures.Rd).
* For exposure prior see XXX.
  
```{r}

# 41-483J
# 43-512H
# Load data clean in the formet required for the model
gambia_pvnt_w2 <- get_data_titre_model_wave2_pvnt_iga()# This is the empirical prior for the exposure time
gambia_exp_w2 <- get_exposures_wave2() # This is the empirical prior for the exposure time
exp_prior_w2 <- get_exp_prior_wave2() # This is the empirical prior for the exposure time


```

## Define the functions required for the rjmcmc model

To help with this section please consult information in the documentation on how to define these functions:

* For observation functions see [obsLogLikelihood](./man/obsLogLikelihood.Rd).
* For COP model functions [copLogLikelihood](./man/copLogLikelihood.Rd).
* For antibody kinetics functions see [abkineticsFunction](./man/abkineticsFunction.Rd).


```{r}
# Define the functions 


obsLogLikelihoodSerum = function(titre_val, titre_est, pars) {
    if (titre_val <= log10(40)) {
        ll <- pnorm(log10(40), titre_est, pars[1], log.p = TRUE)
    } else {
        ll <- dnorm(titre_val, titre_est, pars[1], log = TRUE)
    }
    ll
}

obsLogLikelihoodIgA = function(titre_val, titre_est, pars) {

    ll <- dnorm(titre_val, titre_est, pars[1], log = TRUE)

}


noInfSerumKinetics <- function(titre_est, timeSince, pars) {
    titre_est <- titre_est - pars[1] * (timeSince)
    titre_est <- max(0, titre_est)
}

infSerumKinetics <- function(titre_est, timeSince, pars) {
    a <- pars[1]
    b <- pars[2]
    c <- pars[3]
    s <- pars[4]

    if (timeSince < 14) {
        titre_est <- titre_est + max(1 - s * titre_est, 0) * log(exp(a) + exp(c)) * (timeSince) / 14;
    } else {
        titre_est <- titre_est + max(1 - s * titre_est, 0) * (log(exp(a) * exp(-b/10 * (timeSince - 14)) + exp(c)));
    }
    titre_est
}

infIgAinetics <- function(titre_est, timeSince, pars) {
    d <- pars[1]
    e <- pars[2]
    s <- pars[3]
    h <- pars[4]
    if (timeSince > 249) {
        timeSince <- 250 - 1
    }

    if (timeSince == 0) {
        boost <- 0
    } else {
        x <- timeSince / 250

        sub <- ((1 - x^s) / (d*x^s + 1))^e

        num <- (d + 1) * e * s * x^(s - 1) * sub
        denom <- (1 - x^s) * (d*x^s + 1)
        boost <- num / denom * h
        if (boost < 0) {
            boost <- 0
        } else if (boost > 8){
            boost <- 8
        }
    }
    titre_est + boost
}

# https://www.nature.com/articles/s41598-024-57390-7

pnpfd_PDF <- function(x, d, e, s, h) {
 #   d <- -0.5
 #   e <- 1.5
 #   s <- 2
    sub <- ((1 - x^s) / (d*x^s + 1))^e

    num <- (d + 1) * e * s * x^(s - 1) * sub
    denom <- (1 - x^s) * (d*x^s + 1)

    num / denom * h
}

N <- 100
delta <- runif(N, -1, 50)
eta <- runif(N, 1, 5)
sigma <- runif(N, 2, 5)
heights <- runif(N, 0.5, 5)

df_summary <- map_df(1:N,
    function(i) {
        data.frame(
            samle = i,
            x = seq(0, 1, 0.01),
            f = map_dbl(seq(0, 1, 0.01), pnpfd_PDF, d = delta[i], e = eta[i], s = sigma[i], h = heights[i]) 
        ) 
    }
) %>% group_by(x) %>% mean_qi(f) %>% mutate(x = x * 150)


#df_summary %>% 
 #   ggplot() + 
  #      geom_ribbon(aes(x = x, ymin = .lower, ymax =  .upper), alpha = 0.5) + 
   #     geom_line(aes(x = x, y = f))


```

## Define the models for the rjmcmc model

To help with this section please consult information in the documentation on how to define these lists:

* For observation model see [observationalModel](./man/observationalModel.Rd).
* For COP model see [copModel](./man/copModel.Rd).
* For antibody kinetics see [abkineticsModel](./man/abkineticsModel.Rd).

```{r}

# Define the biomarkers and exposure types in the model
biomarkers <- c("sVNT", "IgA")
exposureTypes <- c("none", "delta", "vax", "predelta")
exposureFitted <- "delta"

# Define the observational model
observationalModel <- list(
    names = c("sVNT", "IgA"),
    model = makeModel(
        addObservationalModel("sVNT", c("sigma"), obsLogLikelihoodSerum),
        addObservationalModel("IgA", c("sigma_a"), obsLogLikelihoodIgA)),
    prior = bind_rows(
        add_par_df("sigma", 0.0001, 4, "unif", 0.0001, 4),
        add_par_df("sigma_a", 0.0001, 4, "unif", 0.0001, 4),
        ) # observational model,
)

# Define the antibody kinetics model
abkineticsModel <- list(
    model = makeModel(
            addAbkineticsModel("none", "sVNT", "none",  c("wane"), noInfSerumKinetics),
            addAbkineticsModel("delta", "sVNT", "delta", c("a_d", "b_d", "c_d"), infSerumKinetics),
            addAbkineticsModel("vax", "sVNT", "vax", c("a_vax", "b_vax", "c_vax"), infSerumKinetics),
            addAbkineticsModel("predelta", "sVNT", "predelta", c("a_pd", "b_pd", "c_pd"), infSerumKinetics),
            addAbkineticsModel("none_a", "IgA", "none",  c("wane_a"), noInfSerumKinetics),
            addAbkineticsModel("delta_a", "IgA", "delta", c("d_d_a", "e_d_a", "s_d_a", "h_d_a"), infIgAinetics),
            addAbkineticsModel("vax_a", "IgA", "vax", c("d_vax_a", "e_vax_a", "s_vax_a", "h_vax_a"), infIgAinetics),
            addAbkineticsModel("predelta_a", "IgA", "predelta", c("d_pd_a", "e_pd_a", "s_pd_a", "h_pd_a"), infIgAinetics)
        ),
    prior = bind_rows(
        add_par_df("a_vax", -6, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_vax", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_vax", 0, 4, "unif", 0,  4), # ab kinetics 
        add_par_df("a_pd", -6, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_pd", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_pd", 0, 4, "unif", 0,  4), # ab kinetics
        add_par_df("a_d", -6, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_d", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_d", 0, 4, "unif", 0,  4), # ab kinetics
        add_par_df("wane", 0.0, 0.01, "unif", 0.0, 0.01), # observational model
        add_par_df("d_vax_a", -1, 50, "unif",  -1, 50), # ab kinetics
        add_par_df("e_vax_a", 1, 5, "unif",  1, 5), # ab kinetics
        add_par_df("s_vax_a", 2, 5, "unif", 2, 5), # ab kinetics 
        add_par_df("h_vax_a", 0.5, 5, "unif", 0.5,  3), # ab kinetics 
        add_par_df("d_pd_a", -1, 50, "unif",  -1, 50), # ab kinetics
        add_par_df("e_pd_a", 1, 5, "unif",  1, 5), # ab kinetics
        add_par_df("s_pd_a", 2, 5, "unif", 2, 5), # ab kinetics 
        add_par_df("h_pd_a", 0.5, 5, "unif", 0.5,  3), # ab kinetics 
        add_par_df("d_d_a", -1, 50, "unif",  -1, 50), # ab kinetics
        add_par_df("e_d_a", 1, 5, "unif",  1, 5), # ab kinetics
        add_par_df("s_d_a", 2, 5, "unif", 2, 5), # ab kinetics 
        add_par_df("h_d_a", 0.5, 5, "unif", 0.5,  3), # ab kinetics 
        add_par_df("wane_a", 0.0, 0.01, "unif", 0.0, 0.01) # observational model
    )
)



inf_prior_1 <- function(N, E, I, K) {
    0
}

inf_prior_2 <- function(N, E, I, K) {
    N_adj <- N - K
    E_adj <- E - K 
    logPriorExpInf <- lfactorial(E_adj) + lfactorial(N_adj - E_adj) - lfactorial(N_adj ) #+ log(1 / N_adj)
    logPriorExpInf
}

inf_prior_3 <- function(N, E, I, K) {
    N_adj <- N - K
    E_adj <- E - K
    logPriorExpInf <- lfactorial(E_adj) + lfactorial(N_adj - E_adj) - lfactorial(N_adj ) + dbinom(E_adj, N_adj, 0.01, log = TRUE)
    logPriorExpInf
}


modeldefinition_p1 <- list(
    biomarkers = biomarkers,
    exposureTypes = exposureTypes,
    exposureFitted = exposureFitted,
    observationalModel = observationalModel,
    abkineticsModel = abkineticsModel,
    exposurePrior = exp_prior_w2,
    exposurePriorType = "empirical",
    expInfPrior = inf_prior_1
)

modeldefinition_p2 <- modeldefinition_p1
modeldefinition_p2$expInfPrior <- inf_prior_2

modeldefinition_p3 <- modeldefinition_p1
modeldefinition_p3$expInfPrior <- inf_prior_3


modelW2_p1 <- createSeroJumpModel(gambia_pvnt_w2, gambia_exp_w2, modeldefinition_p1)
modelW2_p2 <- createSeroJumpModel(gambia_pvnt_w2, gambia_exp_w2, modeldefinition_p2)
modelW2_p3 <- createSeroJumpModel(gambia_pvnt_w2, gambia_exp_w2, modeldefinition_p3)

````

```{r}

devtools::load_all()

settings <-  list(
    numberChainRuns = 4,
    numberCores = 4,
    iterations = 100,
    burninPosterior = 50,
    thin = 1,
    consoleUpdates = 10,
    onAdaptiveCov = TRUE,
    updatesAdaptiveCov = 10,
    burninAdaptiveCov = 1000,
    covarInitVal = 1e-2, # make very small if struggling to sample to beginning
    covarInitValAdapt = 1e-2, # make very small if struggling to sample to beginning
    covarMaxVal = 1, # decrease if struggling toc sample in the middle
    runParallel = TRUE,
    noGibbsSteps = 1,
    onDebug = FALSE,
    profile = TRUE
)

runInfRJMCMC(modelW2_p3, settings, "local/transvir_inf/p3", "wave2")
postprocessFigsInf("local/transvir_inf/p3", "wave2", 4)

```