Fitting to the CRICK data

# Load the data
```{r}

#install.packages("devtools")
#library(devtools)
devtools::load_all()

library(lubridate)
library(patchwork)
library(tidybayes)
library(ggdist)

```

## Get data in the right format for rjmcmc model

To help with this section please consult information in the documentation on how to layour this data.frame:

* For serological data in observational model see [data_titre](../man/data_titre.Rd).
* For known exposure times [data_known_exposures](./man/data_known_exposures.Rd).
* For exposure prior see XXX.
  
```{r}
# Load data clean in the formet required for the model
# THESE FUNCTIONS NEED TO CHANGE TO LOAD IN THE CRICK DATA

data_exp <- get_data_titre_nih_2023_h1()
data_titre <- data_exp[[1]] #%>% check_titre
known_exposure <- data_exp[[2]] %>% unique # must be unique
exp_prior <- data_exp[[3]]

```

```{r}
# Define the functions 

obsLogLikelihood <- function(titre_val, titre_est, pars) {
    if (titre_val < 0) {
        ll <- pnorm(0, titre_est, pars[1], log.p = TRUE)
    } else if (titre_val >= 12){
        ll <- 1 - pnorm(12, titre_est, pars[1], log.p = TRUE)
    } else {
        ll <- log(pnorm(titre_val + 1, titre_est, pars[1]) - pnorm(titre_val , titre_est, pars[1]))
    }
    ll
}

noInfSerumKinetics <- function(titre_est, timeSince, pars) {
    titre_est <- titre_est - pars[1] * (timeSince)
    titre_est <- max(titre_est, 0)
    titre_est
}

infSerumKinetics <- function(titre_est, timeSince, pars) {
    a <- pars[1]
    b <- pars[2]
    c <- pars[3]
    s <- pars[4]

    if (timeSince < 14) {
        titre_est <- titre_est + max(1 - s * titre_est, 0) * log(exp(a) + exp(c)) * (timeSince) / 14;
    } else {
        titre_est <- titre_est + max(1 - s * titre_est, 0) * (log(exp(a) * exp(-b/10 * (timeSince - 14)) + exp(c)));
    }
    titre_est
}

```



## Define the models for the rjmcmc model

To help with this section please consult information in the documentation on how to define these lists:

* For observation model see [observationalModel](./man/observationalModel.Rd).
* For COP model see [copModel](./man/copModel.Rd).
* For antibody kinetics see [abkineticsModel](./man/abkineticsModel.Rd).

```{r}

# Define the biomarkers and exposure types in the model
biomarkers <- c("A/Sydney/5/2021", "A/Sydney/5/2021e")
exposureTypes <- c("vax", "h1_2023")
exposureFitted <- c("h1_2023")

# Define the observational model
observationalModel <- list(
    model = makeModel(
        addObservationalModel("A/Sydney/5/2021", c("sigma"), obsLogLikelihood),
        addObservationalModel("A/Sydney/5/2021e", c("sigma_e"), obsLogLikelihood)
        ),
    prior = bind_rows(
        add_par_df("sigma", 0.0001, 4, "unif", 0.0001, 4),
        add_par_df("sigma_e", 0.0001, 4, "unif", 0.0001, 4)
        ) # observational model,
)

# Define the antibody kinetics model
abkineticsModel <- list(
    model = makeModel(
            addAbkineticsModel("vax", "A/Sydney/5/2021", "vax", c("a_vax", "b_vax", "c_vax", "s_vax"), infSerumKinetics),
            addAbkineticsModel("h1_2023","A/Sydney/5/2021", "h1_2023", c("a_v", "b_v", "c_v", "s_v"), infSerumKinetics),
            addAbkineticsModel("vax_e", "A/Sydney/5/2021e", "vax", c("a_vax_e", "b_vax_e", "c_vax_e", "s_vax_e"), infSerumKinetics),
            addAbkineticsModel("h1_2023_e", "A/Sydney/5/2021e", "h1_2023", c("a_v_e", "b_v_e", "c_v_e", "s_v_e"), infSerumKinetics)
        ),
    prior = bind_rows(
        add_par_df("a_vax", -5, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_vax", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_vax", 0, 4, "unif", 0, 4), # ab kinetics 
        add_par_df("s_vax", 0, 1, "unif", 0, 1), # ab kinetics 
        add_par_df("a_v", -5, 6, "unif",  0, 1), # ab kinetics
        add_par_df("b_v", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_v", 1, 4, "unif", 1, 4), # ab kinetics
        add_par_df("s_v", 0, 1, "unif", 0, 1), # ab kinetics
        add_par_df("a_vax_e", -5, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_vax_e", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_vax_e", 0, 4, "unif", 0, 4), # ab kinetics 
        add_par_df("s_vax_e", 0, 1, "unif", 0, 1), # ab kinetics 
        add_par_df("a_v_e", -5, 6, "norm",  0, 2), # ab kinetics
        add_par_df("b_v_e", 0, 1, "norm",  0.3, 0.05), # ab kinetics
        add_par_df("c_v_e", 1, 4, "unif", 1, 4), # ab kinetics
        add_par_df("s_v_e", 0, 1, "unif", 0, 1) # ab kinetics 

    )
)

inf_prior_1 <- function(N, E, I, K) {
    0
}

inf_prior_2 <- function(N, E, I, K) {
    N_adj <- N - K
    E_adj <- E - K 
    logPriorExpInf <- lfactorial(E_adj) + lfactorial(N_adj - E_adj) - lfactorial(N_adj ) #+ log(1 / N_adj)
    logPriorExpInf
}

inf_prior_3 <- function(N, E, I, K) {
    N_adj <- N - K
    E_adj <- E - K
    logPriorExpInf <- lfactorial(E_adj) + lfactorial(N_adj - E_adj) - lfactorial(N_adj ) + dbinom(E_adj, N_adj, 0.01, log = TRUE)
    logPriorExpInf
}


# Define the COP model


modeldefinition_p1 <- list(
    biomarkers = biomarkers,
    exposureTypes = exposureTypes,
    exposureFitted = exposureFitted,
    observationalModel = observationalModel,
    abkineticsModel = abkineticsModel,
    expInfPrior = inf_prior_1,
    exposurePrior = exp_prior,
    exposurePriorType = "empirical"
)

modeldefinition_p2 <- modeldefinition_p1
modeldefinition_p2$expInfPrior <- inf_prior_2

modeldefinition_p3 <- modeldefinition_p1
modeldefinition_p3$expInfPrior <- inf_prior_3


seroModel_nih_p1 <- createSeroJumpModel(data_titre, known_exposure, modeldefinition_p1)
seroModel_nih_p2 <- createSeroJumpModel(data_titre, known_exposure, modeldefinition_p2)
seroModel_nih_p3 <- createSeroJumpModel(data_titre, known_exposure, modeldefinition_p3)


# prior_predictive_ab(seroModel_nih_p1)
# seroModel_nih_p1$data$knownInfsVec %>% sum
````


```{r}

devtools::load_all()

settings <-  list(
    numberChainRuns = 4,
    numberCores = 4,
    iterations = 200000,
    burninPosterior = 100000,
    thin = 100,
    consoleUpdates = 1000,
    onAdaptiveCov = TRUE,
    updatesAdaptiveCov = 10,
    burninAdaptiveCov = 1000,
    covarInitVal = 1e-2, # make very small if struggling to sample to beginning
    covarInitValAdapt = 1e-2, # make very small if struggling to sample to beginning
    covarMaxVal = 1, # decrease if struggling toc sample in the middle
    runParallel = TRUE,
    noGibbsSteps = 1,
    onDebug = FALSE
)


runInfRJMCMC(seroModel_nih_p1, settings, "local/nih_2024_inf/prior1", "h1")
postprocessFigsInf("local/nih_2024_inf/prior1", "h1", 4)
# Getting suck at high values of infection ??

runInfRJMCMC(seroModel_nih_p2, settings, "local/nih_2024_inf/prior2", "h3")
require(bayesplot)
postprocessFigsInf("local/nih_2024_inf/prior2", "h3", 4)


runInfRJMCMC(seroModel_nih_p3, settings, "local/nih_2024_inf/prior3", "h3")
postprocessFigsInf("local/nih_2024_inf/prior3", "h3", 4)

```